## LangGraph 多 Agent 交互规划

目标：为每位用户提供“面试复盘 AI 导师”，由底层 Graph 管理多个 Agent 的协作，自动完成从转录读取、问答总结到动态回访的多步骤推理，保证体验智能、可控、可扩展。

### 1. 整体架构
1. **Graph Orchestrator**：LangGraph 负责状态管理、节点调度、并发控制，支持多轮对话上下文与任务缓存。
2. **核心 Agent 组成**  
   - **Planner Agent**：接收用户意图（上传、分析、追问等），拆解成子任务图。  
   - **Transcription Analyzer**：从转录文本中抽取 QA、时间戳。  
   - **Insight Synthesizer**：输出表现亮点、待改进、快速总结；可根据岗位/公司动态调整 Prompt。  
   - **Action Coach**：给出 STAR、公司调研等行动建议，支持优先级排序。  
   - **Conversation Agent**：处理用户自由提问，引用已有分析结果，必要时触发 Planner 更新分析。  
3. **Memory Layer**：使用 LangGraph 的状态节点或外部存储（Redis/数据库）记录：用户偏好、历史问题、已完成任务。  
4. **Tooling 接口**：  
   - 文件/转录读取  
   - 分析结果持久化（StorageService）  
   - 导出/分享触发事件  
   - 外部知识库（如公司信息、岗位 JD）

### 2. Graph 流程设计
1. **入口节点**：接收用户命令（前端操作、聊天指令）。  
2. **Planner 节点**：判断任务类型（上传、分析、追问、导出），构建子任务列表。  
3. **执行链**：依据任务类型走不同子图：  
   - `转录→QA 抽取→洞察总结→建议生成`  
   - `追问→检查上下文→回答/触发重新分析`  
4. **记忆更新节点**：写入分析结果、用户偏好。  
5. **回执节点**：将结果封装为前端所需结构（panel、导出、分享），并返回 Conversation Agent 生成自然语言回复。

### 3. 智能化策略
1. **动态 Prompt**：Planner 根据岗位、公司、用户反馈调整下游 Agent 的角色提示与输出模板。  
2. **意图分类 + Tool Routing**：结合检索增强，判定用户提问是否需要重跑分析/局部更新。  
3. **Memory-Aware Responses**：Conversation Agent 结合长期记忆（以往面试、用户偏好）提供上下文相关建议。  
4. **质量控制**：  
   - 对关键输出（QA、建议）引入校验节点（长度、敏感词、JSON schema）。  
   - 失败时自动回退到上一个稳定状态并提示用户。  
5. **可扩展节点**：预留“知识补充”“模拟面试”节点，未来可按需扩展。

### 4. 实施计划
1. **阶段 1：原型**  
   - 选定 LangGraph (Python) 版本；梳理现有 API 与数据结构。  
   - 实现最小图：Planner + Analyzer + Synthesizer + Conversation。  
   - 打通上传→分析→问答的端到端流水线。
2. **阶段 2：智能增强**  
   - 接入公司信息/岗位 JD 检索工具。  
   - 完善 Memory 层，支持跨面试引用历史。  
   - 加入质量控制节点与重试策略。
3. **阶段 3：产品化**  
   - 与前端聊天/报告面板深度集成，支持实时状态显示。  
   - 记录 Graph 事件用于监控与调试。  
   - 扩展导出、分享触发的 Agent（自动生成分享话术、邮件草稿等）。

### 5. 风险与对策
- **API 成本**：引入缓存、增量更新，减少重复调用。  
- **上下文长度**：使用分块提取 + 向量检索，避免长转录导致溢出。  
- **可靠性**：Graph 节点失败需有 fallback 及人工审核入口。  
- **安全与隐私**：敏感数据在 Memory 中加密存储，Agent Prompt 中避免泄露。

### 6. 验收指标
1. 端到端平均响应时间（上传→报告）  
2. Agent 输出合规率（schema 校验通过率）  
3. 用户追问命中率（能直接引用已有分析的比例）  
4. 试点用户满意度/问题解决率  
5. 关键节点失败率与自动重试成功率
